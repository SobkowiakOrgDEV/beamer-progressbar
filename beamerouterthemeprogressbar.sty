\ProvidesPackage{beamerouterthemeprogressbar}[20011/05/02]

% Beamer theme by Sylvain Bouveret <sylvain[dot]bouveret[aT]cert[DoT]fr>
% based on the LaTeX-Beamer package :
%
% Copyright 2003 by Till Tantau <tantau@users.sourceforge.net>
%
% This program can be redistributed and/or modified under the terms
% of the GNU Public License, version 2.

% This fork was created to satisfy personnal taste in code.
%
% Last modified by CÃ©dric Mauclair.


\RequirePackage{calc}
\usetikzlibrary[arrows]

%<< progress bar         >>

% some computations dedicated to the progressbar
\newdimen\pb@frame
\newdimen\pb@bar
\newdimen\pb@step
\newdimen\pb@margin

\pb@margin=2mm

\newcommand\setdim[2]{#1\dimexpr#2\relax}
\newcommand\gsetdim[2]{\global#1\dimexpr#2\relax}

% progressbar
\def\insertprogressbar{%
  % do some computations once...
  \ifnum\insertframenumber=1
    \setbox\@tempboxa=\hbox{%
      \usebeamerfont{section in head/foot}%
      \usebeamercolor[fg]{section in head/foot}%
      \inserttotalframenumber~/~\inserttotalframenumber}
    \@tempdima=\wd\@tempboxa

    \gsetdim\pb@frame \@tempdima
    \gsetdim\pb@bar   {\paperwidth-\@tempdima-3\pb@margin}
    \gsetdim\pb@step  {\pb@bar/(\inserttotalframenumber-2)}
  % ... but don't put the progressbar on the first page (not frame!)
  \else
    \setdim\@tempdima {\pb@step*(\insertframenumber-2)}
    \begin{tikzpicture}[thin, inner sep=0pt]
      \usebeamerfont{section in head/foot}
      \usebeamercolor{section in head/foot}
      \path [use as bounding box]
        (0,-1mm) rectangle ++(\paperwidth,0);
      \node [anchor=west, text=fg]
        at (\paperwidth-\pb@margin-\pb@frame,2.1mm)
        {\insertframenumber~/~\inserttotalframenumber};
      \node [anchor=south east, text=fg]
        at (\paperwidth-2\pb@margin-\pb@frame-0.4mm,2.6mm)
        {\insertshorttitle};
      \path [draw, color=fg!30!bg, <->, >=serif cm]
        (\pb@margin,2.1mm) -- ++(\pb@bar,0);
      \node [anchor=north, text=fg!30!bg]
        at (\@tempdima+\pb@margin,2.1mm) {$\blacktriangle$};
    \end{tikzpicture}
  \fi}

%>>
%<< customized templates >>

% \newlength\pb@sectionboxwidth
% \newlength\pb@sectionboxheight
% \newbox\pb@sectionbox
% \newbox\pb@sectionboxbox

\usesectionheadtemplate
  {\hfill
    \setbox\pb@sectionbox=\hbox{\insertsectionhead}%
    \pb@sectionboxwidth=\wd\pb@sectionbox
    \advance\pb@sectionboxwidth by 4pt
    \setbox\pb@sectionbox=\hbox{\pgfinterruptpicture t \endpgfinterruptpicture}%
    \pb@sectionboxheight=\ht\pb@sectionbox
    \advance\pb@sectionboxheight by 4pt
    \begin{tikzpicture}
      \usebeamercolor{section in head/foot}
      \useasboundingbox (-0.5\pb@sectionboxwidth, 0pt) rectangle (0.5\pb@sectionboxwidth, \pb@sectionboxheight);
      \draw[anchor=base] (0pt, 2pt) node {\color{fg} \insertsectionhead};
      \draw[rounded corners=3pt, draw=fg] (-0.5\pb@sectionboxwidth, 0pt) rectangle (0.5\pb@sectionboxwidth, \pb@sectionboxheight);
    \end{tikzpicture}
  }
  {\hfill
    \setbox\pb@sectionbox=\hbox{\pgfinterruptpicture\insertsectionhead\endpgfinterruptpicture}%
    \pb@sectionboxwidth=\wd\pb@sectionbox
    \advance\pb@sectionboxwidth by 4pt
    \setbox\pb@sectionboxbox=\hbox{\pgfinterruptpicture t \endpgfinterruptpicture}%
    \pb@sectionboxheight=\ht\pb@sectionboxbox
    \advance\pb@sectionboxheight by 4pt
    \begin{tikzpicture}
      \usebeamercolor{section in head/foot}
      \useasboundingbox (-0.5\pb@sectionboxwidth, 0pt) rectangle (0.5\pb@sectionboxwidth, \pb@sectionboxheight);
      \draw[anchor=base] (0pt, 2pt) node {\color{fg} \insertsectionhead};
    \end{tikzpicture}
  }

%>>
%<< headline/footline    >>

\def\const@none{none}
\def\const@sections{sections}

\defbeamertemplate*{headline}{progressbar}{%
  \leavevmode
  \begin{beamercolorbox}
    [ignorestructure.bg=true, wd=\paperwidth, ht=4ex, dp=1.125ex]{structure.fg}
    \ifx\pb@headline\const@sections
      \insertsectionnavigationhorizontal{\paperwidth}{}{}
    \fi
  \end{beamercolorbox}}

\defbeamertemplate*{footline}{progressbar}
  {\insertprogressbar}

%>>
%<< title page           >>

\defbeamertemplate*{title page}{progressbar}{
  \edef\tempa{picture}
  \ifx\pb@barpage\tempa
  \vfill
  \parbox{0.28\textwidth}{
    \pgfimage[width=0.27\textwidth]{\pb@imagename}
  }\hfill
  \parbox{0.7\textwidth}{
    \begin{center}
      {\usebeamerfont{title}\usebeamercolor{title}{\color{fg}\inserttitle}}
      \ifx\insertsubtitle\@empty\\[\baselineskip]
      \else{\\\usebeamerfont{subtitle}\usebeamercolor{subtitle}{\color{fg}\insertsubtitle}}\\[\baselineskip]\fi
      \hrule\vskip\baselineskip
      \ifx\insertauthor\@empty\ \\
      \else{\usebeamerfont{author}\usebeamercolor{author}{\color{fg}\insertauthor}}\\\fi
      \ifx\insertdate\@empty\ \\
      \else{\usebeamerfont{date}\usebeamercolor{date}{\color{fg}\insertdate}}\\\fi
      \ifx\insertinstitute\@empty
      \else{\usebeamerfont{institute}\usebeamercolor{institute}{\color{fg}\insertinstitute}}\\\fi
      \insertlogo
    \end{center}
  }\vfill
  \else
  \pgfdeclarehorizontalshading{separationtitlepagelineshading}{0.5pt}{color(0cm)=(bg);
    color(0.5\textwidth)=(structure.fg); color(\textwidth)=(bg)}
  \begin{center}
    \vfill
    {\usebeamerfont{title}\usebeamercolor{title}{\color{fg}\inserttitle}}

    \ifx\insertsubtitle\@empty
    \else{\usebeamerfont{subtitle}\usebeamercolor{subtitle}{\color{fg}\insertsubtitle}}\\[\baselineskip]\fi

    \pgfuseshading{separationtitlepagelineshading}
    \ifx\insertauthor\@empty\ \\
    \else{\usebeamerfont{author}\usebeamercolor{author}{\color{fg}\insertauthor}}\\\fi
    \ifx\insertdate\@empty\ \\
    \else{\usebeamerfont{date}\usebeamercolor{date}{\color{fg}\insertdate}}\\\fi
    \ifx\insertinstitute\@empty
    \else{\usebeamerfont{institute}\usebeamercolor{institute}{\color{fg}\insertinstitute}}\\\fi
    \insertlogo
    \pgfuseshading{separationtitlepagelineshading}
    \vfill
  \end{center}
  \fi
}

%>>
%<< background           >>

\defbeamertemplate*{background canvas}{progressbar}{\pgfuseshading{background shading}}%

\AtBeginDocument{%
  {
    \usebeamercolor{section in head/foot}
    \usebeamercolor{normal text}
    \pgfdeclareverticalshading{background shading}{\the\paperwidth}{color(0cm)=(section in head/foot.bg); color(3cm)=(bg); color(0.6\paperheight)=(bg); color(0.9\paperheight)=(section in head/foot.bg); color(\paperheight)=(black!60!section in head/foot.bg)
    }
  }
}

%>>

% \mode<handout>{%
%   \setbeamertemplate{background canvas}{}%
%   \setbeamertemplate{footline}{
%     \begin{beamercolorbox}[wd=\paperwidth, ht=6mm, dp=0pt]{structure.fg}
%       \quad\insertshorttitle\hfill
%       \insertframenumber~/~\inserttotalframenumber\quad
%       \vskip0.1cm
%     \end{beamercolorbox}}}


%%% Local Variables:
%%% TeX-master: "./demo.tex"
%%% End:

